<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- -------------------- Configurable Settings -------------------- -->
    <script>
      const CONFIG = {
        // üñºÔ∏è The image displayed at the top of the scratch card (treasure chest or prize image)
        imageUrl:
          "https://eu1-static.dashboard.clevertap.com/static-images/dashboard/inapps/gamification-templates/scratch-the-card-chest.png?v=0",

        // ‚ùå Whether to show the X button to close/dismiss the card (true = show, false = hide)
        includeDismissButton: true,

        // üåà Background color/gradient of the entire scratch card
        background:
          "linear-gradient(180deg, #41F4BC 0%, #35ABFF 37.98%, #0060A5 100%)",

        // üéâ Background color/gradient after the reward is revealed
        revealedBackground: "linear-gradient(180deg, #41F4BC 0%, #35ABFF 100%)",

        // üéâ Whether to enable the confetti effect on reveal
        enableConfettiOnReveal: true,

        // ‚ú® Reveal button settings
        revealButton: {
          enabled: true,
          text: "Reveal My Prize",
          background: "#ffffff",
          color: "#1d1d1d",
        },

        // üõçÔ∏è Claim button settings
        claimButton: {
          enabled: true,
          text: "Claim",
          background: "linear-gradient(180deg, #A4FFE4 -0.8%, #41F2BE 99.2%)",
          color: "#000000",
          url: "wzkr://thisleadstonowhere",
        },

        // üó£Ô∏è Main headline settings
        mainTitle: {
          // üì¢ Text for the main headline (supports HTML like <br> for line breaks)
          text: "Scratch & Win: <br>A Surprise Awaits!",

          // üìè Size of the main headline text
          fontSize: "24px",

          // üé® Color of the main headline text
          color: "#ffffff",

          // ‚ú® Text shadow for the main headline
          textShadow: "0 2px 4px rgba(0, 0, 0, 0.3)",
        },

        // üí¨ Subtitle/description settings
        subtitle: {
          // üìù Text for the subtitle/description below the headline
          text: "Feeling lucky? Scratch the card to reveal your reward ‚Äî discounts, freebies, or even something BIG! Ready to try your luck?",

          // üìè Size of the subtitle text
          fontSize: "14px",

          // üé® Color of the subtitle text
          color: "#e8f5ff",
        },

        // ‚è∞ Black Friday Timer settings
        blackFridayTimer: {
          // üîÑ Whether to show the timer after revealing the reward
          enabled: true,

          // üìÖ Black Friday end date (you can adjust this)
          endDate: "2025-11-29T23:59:59",

          // üì¢ Timer title text
          title: "‚ö° Black Friday Sale Ends In:",

          // üé® Timer styling
          titleColor: "#ffffff",
          timerColor: "#FFD700",
          backgroundColor: "rgba(0, 0, 0, 0.3)",
        },

        // üéÅ List of possible rewards that can appear after scratching
        rewards: [
          {
            // üè∑Ô∏è Text shown as title of the reward
            title: "Congrats! You just won a Promo Code!",

            // üéüÔ∏è Value to copy when user clicks the copy button (usually a coupon code)
            value: "DISCOUNT10",

            // ‚ÑπÔ∏è Small description text shown below the main reward
            subtext:
              "Use DISCOUNT10 at checkout to get 10% off your order. Valid through April 30.",

            // üé≤ Chance of getting this reward (0.45 = 45% chance)
            probability: 0.45,
          },
          {
            title: "Congrats! You just won a Discount!",
            value: "SPRING20",
            subtext:
              "Use SPRING20 at checkout to get 20% off your order. Valid through April 30.",
            probability: 0.25,
          },
          {
            title: "Congrats! You just won a Free Shipping!",
            value: "FREESHIP",
            subtext:
              "Use FREESHIP at checkout to enjoy free shipping on your order. Valid through April 30.",
            probability: 0.2,
          },
          {
            title: "Congrats! You just won a Gift Card!",
            value: "GIFT100",
            subtext:
              "Congratulations! You'll receive your $100 gift card via email. Valid through April 30.",
            probability: 0.1,
          },
        ],
      };
    </script>
    <!-- -------------------- End of Configurable Settings -------------------- -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scratch & Win - Surprise Awaits!</title>

    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-evenly;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      }

      :root {
        --shimmer-hue-1: 213deg;
        --shimmer-hue-2: 248deg;
        --shimmer-hue-3: 293deg;
      }

      @property --mask {
        syntax: "<angle>";
        inherits: false;
        initial-value: 33deg;
      }

      @keyframes spin {
        0% {
          --mask: 0deg;
        }

        100% {
          --mask: 360deg;
        }
      }

      .modal {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        max-height: 560px;
        max-width: 320px;
        padding: 0 5%;
        justify-content: space-evenly;
        width: 100%;
        color: #ffffff;
        text-align: center;
        background: linear-gradient(
          180deg,
          #41f4bc 0%,
          #35abff 37.98%,
          #0060a5 100%
        );
        border-radius: 36px;
        position: relative;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* Close button */
      .close-btn {
        position: absolute;
        top: 18px;
        right: 18px;
        appearance: none;
        border: 0;
        background: none;
        color: #ffffff;
        font-size: 32px;
        line-height: 1;
        cursor: pointer;
      }

      /* Illustration placeholder (replace src if desired) */
      .treasure-img {
        width: 150px;
        display: block;
      }

      /* Headings & text */
      h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      p {
        margin: 0;
        font-size: 14px;
        line-height: 1.45;
        color: #e8f5ff;
      }

      .subtitle-container {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      /* Scratch-card container */
      .scratch-wrapper {
        box-sizing: border-box;
        width: 100%;
        height: 100px;
        position: relative;
        border-radius: 18px;
        border: 4px solid #4a4c4c33;
        overflow: visible;
        cursor: pointer;
      }

      .reward {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #ffffff;
        color: #1d1d1d;
        font-size: 24px;
        font-weight: 700;
        gap: 8px;
        padding: 0 10px;
        border-radius: 18px;
        cursor: pointer;
      }

      canvas.scratcher {
        position: absolute;
        inset: 0;
        cursor: crosshair;
        border-radius: 18px;
      }

      /* Reveal button */
      .reveal-btn {
        width: fit-content;
        padding: 12.5px 40px;
        border: none;
        border-radius: 14px;
        background: #ffffff;
        color: #1d1d1d;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
      }

      .reveal-btn:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .copy-btn {
        display: inline;
        min-width: 20px;
        max-width: 20px;
        appearance: none;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 24px;
        line-height: 1;
        color: #1d1d1d;
        transition: transform 0.1s ease-in-out;
      }

      .copy-btn:active {
        transform: scale(0.9);
      }

      /* Reward internal layout */
      .reward-main {
        display: flex;
        align-items: center;
        gap: 3px;
      }

      .reward .subtext {
        font-weight: 400;
        font-size: 12px;
        line-height: 100%;
        text-align: center;
        color: #4a4c4c;
      }

      .copy-instruction {
        font-family: "Proxima Nova", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
          "Helvetica Neue", sans-serif;
        font-weight: 500;
        font-size: 12px;
        line-height: 100%;
        letter-spacing: 0%;
        text-align: center;
        color: #606060;
        margin-top: 4px;
      }

      @keyframes move {
        0% {
          transform: translateY(0) translateZ(0);
        }

        50% {
          transform: translateY(-8px) translateZ(0);
        }

        100% {
          transform: translateY(0) translateZ(0);
        }
      }

      /* Pulsating animation for scratch area */
      @keyframes pulsate {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.05);
        }

        100% {
          transform: scale(1);
        }
      }

      .pulsate-animation {
        animation: pulsate 1.5s 3;
        /* Run 3 times */
      }

      /* Shimmer effect for scratch area */
      .shimmer {
        position: absolute;
        inset: -40px;
        border-radius: inherit;
        mix-blend-mode: plus-lighter;
        pointer-events: none;
        opacity: 0;
        visibility: hidden;
        mask-image: conic-gradient(
          from var(--mask, 0deg),
          transparent 0%,
          transparent 10%,
          black 36%,
          black 45%,
          transparent 50%,
          transparent 60%,
          black 85%,
          black 95%,
          transparent 100%
        );
        mask-size: cover;
        animation: spin 3s linear infinite both -0.5s;
        z-index: 10;
        transition: opacity 0.3s ease-in-out;
      }

      .shimmer::before,
      .shimmer::after {
        content: "";
        border-radius: inherit;
        position: absolute;
        inset: 40px;
        opacity: 1;
      }

      .shimmer::before {
        box-shadow: 0 0 2px 1px hsl(var(--shimmer-hue-1) 60% 95%),
          0 0 5px 3px hsl(var(--shimmer-hue-1) 60% 80%),
          0 0 9px 6px hsl(var(--shimmer-hue-2) 70% 60%),
          0 0 14px 7px hsl(var(--shimmer-hue-2) 50% 40%);
        z-index: -1;
      }

      /* Make the shimmer visible when reward is revealed */
      .scratch-wrapper.shimmer-active .shimmer {
        opacity: 1;
        visibility: visible;
        animation: spin 2s linear infinite;
      }

      /* Black Friday Timer Styles */
      .black-friday-timer {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 12px;
        margin-top: 16px;
        width: 100%;
        box-sizing: border-box;
      }

      .timer-title {
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        margin: 0;
      }

      .timer-display {
        display: flex;
        gap: 8px;
        align-items: center;
        font-weight: 700;
        font-size: 18px;
      }

      .timer-unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 35px;
      }

      .timer-number {
        font-size: 20px;
        line-height: 1;
      }

      .timer-label {
        font-size: 10px;
        text-transform: uppercase;
        opacity: 0.8;
        margin-top: 2px;
      }

      .timer-separator {
        font-size: 16px;
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.3;
        }
      }

      .timer-expired {
        font-size: 16px;
        font-weight: 600;
        color: #ff6b6b;
      }
    </style>
  </head>

  <body>
    <div class="modal" id="modal">
      <button class="close-btn" aria-label="Close">x</button>

      <img class="treasure-img" height="120" alt="Treasure Chest" />
      <h1 class="title" id="mainTitle"></h1>
      <div class="subtitle-container">
        <p id="subtitle"></p>
      </div>

      <div class="scratch-wrapper" id="scratchCard">
        <span class="shimmer"></span>
        <div class="reward" id="reward">
          <div class="reward-main">
            <span id="rewardText"></span>
            <button id="copyBtn" class="copy-btn" title="Copy to clipboard">
              <svg
                width="20"
                height="21"
                viewBox="0 0 20 21"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M13 13.8444V17.8444C13 18.4444 12.6 18.8444 12 18.8444H3C2.4 18.8444 2 18.4444 2 17.8444V8.84442C2 8.24442 2.4 7.84442 3 7.84442H7V3.84442C7 3.24442 7.4 2.84442 8 2.84442H17C17.6 2.84442 18 3.24442 18 3.84442V12.8444C18 13.4444 17.6 13.8444 17 13.8444H13ZM12 13.8444H8C7.4 13.8444 7 13.4444 7 12.8444V8.84442H3V17.8444H12V13.8444ZM17 3.84442H8V12.8444H17V3.84442Z"
                  fill="#4A4C4C"
                />
              </svg>
            </button>
          </div>
          <div class="copy-instruction">Click here to copy the code!</div>
        </div>
        <canvas
          class="scratcher"
          role="button"
          tabindex="0"
          aria-label="Scratch the card"
        ></canvas>
      </div>

      <!-- Black Friday Timer -->
      <div class="black-friday-timer" id="blackFridayTimer">
        <p class="timer-title" id="timerTitle"></p>
        <div class="timer-display" id="timerDisplay">
          <div class="timer-unit">
            <span class="timer-number" id="days">00</span>
            <span class="timer-label">Days</span>
          </div>
          <span class="timer-separator">:</span>
          <div class="timer-unit">
            <span class="timer-number" id="hours">00</span>
            <span class="timer-label">Hrs</span>
          </div>
          <span class="timer-separator">:</span>
          <div class="timer-unit">
            <span class="timer-number" id="minutes">00</span>
            <span class="timer-label">Mins</span>
          </div>
          <span class="timer-separator">:</span>
          <div class="timer-unit">
            <span class="timer-number" id="seconds">00</span>
            <span class="timer-label">Secs</span>
          </div>
        </div>
      </div>

      <button class="reveal-btn" id="revealButton">Reveal My Prize</button>
    </div>

    <script>
      (function () {
        const modal = document.getElementById("modal");
        const wrapper = document.getElementById("scratchCard");
        const canvas = wrapper.querySelector("canvas");
        const ctx = canvas.getContext("2d");
        const footerButton = document.getElementById("revealButton");
        const copyBtn = document.getElementById("copyBtn");
        const closeBtn = modal.querySelector(".close-btn");
        const reward = document.getElementById("reward");
        const blackFridayTimer = document.getElementById("blackFridayTimer");
        let isDrawing = false;
        let timerInterval = null;

        // -------------------- Apply Config --------------------

        // Modal background
        if (CONFIG.background) {
          modal.style.background = CONFIG.background;
        }

        // Dismiss button visibility
        if (!CONFIG.includeDismissButton && closeBtn) {
          closeBtn.style.display = "none";
        }

        // Image source
        const imgEl = document.querySelector(".treasure-img");
        if (CONFIG.imageUrl) {
          imgEl.src = CONFIG.imageUrl;
        }

        // Main title styling/content
        const mainTitleEl = document.getElementById("mainTitle");
        if (mainTitleEl) {
          mainTitleEl.innerHTML = CONFIG.mainTitle.text;
          mainTitleEl.style.fontSize = CONFIG.mainTitle.fontSize;
          mainTitleEl.style.color = CONFIG.mainTitle.color;
          mainTitleEl.style.textShadow = CONFIG.mainTitle.textShadow;
        }

        // Subtitle styling/content
        const subtitleEl = document.getElementById("subtitle");
        if (subtitleEl) {
          subtitleEl.textContent = CONFIG.subtitle.text;
          subtitleEl.style.fontSize = CONFIG.subtitle.fontSize;
          subtitleEl.style.color = CONFIG.subtitle.color;
        }

        // Reveal button visibility (initial state)
        if (!CONFIG.revealButton.enabled) {
          footerButton.style.display = "none";
        } else {
          // Set initial reveal button text and colors from config
          footerButton.textContent = CONFIG.revealButton.text;
          footerButton.style.background = CONFIG.revealButton.background;
          footerButton.style.color = CONFIG.revealButton.color;
        }

        // Black Friday Timer configuration
        if (CONFIG.blackFridayTimer.enabled) {
          const timerTitleEl = document.getElementById("timerTitle");
          if (timerTitleEl) {
            timerTitleEl.textContent = CONFIG.blackFridayTimer.title;
            timerTitleEl.style.color = CONFIG.blackFridayTimer.titleColor;
          }

          // Style the timer container
          blackFridayTimer.style.backgroundColor =
            CONFIG.blackFridayTimer.backgroundColor;

          // Style timer numbers
          const timerNumbers = blackFridayTimer.querySelectorAll(
            ".timer-number, .timer-separator"
          );
          timerNumbers.forEach((el) => {
            el.style.color = CONFIG.blackFridayTimer.timerColor;
          });
        }

        // Black Friday Timer Functions
        function startBlackFridayTimer() {
          if (!CONFIG.blackFridayTimer.enabled) return;

          const endDate = new Date(CONFIG.blackFridayTimer.endDate).getTime();

          function updateTimer() {
            const now = new Date().getTime();
            const timeLeft = endDate - now;

            if (timeLeft > 0) {
              const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
              const hours = Math.floor(
                (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
              );
              const minutes = Math.floor(
                (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
              );
              const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

              document.getElementById("days").textContent = String(
                days
              ).padStart(2, "0");
              document.getElementById("hours").textContent = String(
                hours
              ).padStart(2, "0");
              document.getElementById("minutes").textContent = String(
                minutes
              ).padStart(2, "0");
              document.getElementById("seconds").textContent = String(
                seconds
              ).padStart(2, "0");
            } else {
              // Timer expired
              clearInterval(timerInterval);
              document.getElementById("timerDisplay").innerHTML =
                '<div class="timer-expired">üî• Sale Ended!</div>';
            }
          }

          updateTimer(); // Update immediately
          timerInterval = setInterval(updateTimer, 1000); // Update every second
          blackFridayTimer.style.display = "flex";
        }

        // --- Reward Configuration --------------------------------------
        const rewards = CONFIG.rewards;

        // URL to open when the user claims their reward
        const CLAIM_URL = CONFIG.claimButton.url;

        function chooseReward() {
          // Sum of probabilities (doesn't need to equal 1)
          const total = rewards.reduce((acc, r) => acc + r.probability, 0);
          let rand = Math.random() * total;
          for (const reward of rewards) {
            if (rand < reward.probability) return reward;
            rand -= reward.probability;
          }
          // Fallback - should never reach but keeps TS/linters happy
          return rewards[rewards.length - 1];
        }

        const selectedReward = chooseReward();
        document.getElementById("rewardText").textContent =
          selectedReward.value;

        // Clipboard copy handler
        copyBtn.addEventListener("click", () => {
          // Try using the modern Clipboard API first
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(selectedReward.value)
              .then(showCopySuccess)
              .catch(() => fallbackCopy(selectedReward.value));
          } else {
            // Fallback for mobile browsers
            fallbackCopy(selectedReward.value);
          }
        });

        // Copy functionality for the whole scratch area
        function copyToClipboard() {
          const text = selectedReward.value;
          if (!text) return;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(text)
              .then(showCopySuccess)
              .catch(() => fallbackCopy(text));
          } else {
            fallbackCopy(text);
          }
        }

        // Clipboard copy handler for scratch area
        function copyScratchAreaText(e) {
          // Only allow copying after the reward is revealed (canvas is hidden)
          if (canvas.style.opacity !== "0") return;

          // If the click was on the copy button, don't execute this handler
          if (
            (e && e.target === copyBtn) ||
            (e.target.closest && e.target.closest("#copyBtn"))
          ) {
            return;
          }

          copyToClipboard();
        }

        // Add click handler to copy button (prevent event bubbling)
        copyBtn.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevent the scratch area click handler from firing
        });

        // Add click handler to the entire scratch area
        wrapper.addEventListener("click", copyScratchAreaText);

        function showCopySuccess() {
          const copyInstructionEl = document.querySelector(".copy-instruction");
          if (copyInstructionEl) {
            copyInstructionEl.textContent = "Code copied!";
            copyInstructionEl.style.color = "#40f3bd";

            setTimeout(() => {
              copyInstructionEl.textContent = "Click here to copy the code!";
              copyInstructionEl.style.color = "#606060";
            }, 1500);
          }
        }

        function fallbackCopy(text) {
          // Create temporary input element
          const input = document.createElement("input");
          input.setAttribute("readonly", "");
          input.setAttribute("value", text);
          input.style.position = "absolute";
          input.style.left = "-9999px";
          document.body.appendChild(input);

          // Handle iOS devices
          const isIOS = navigator.userAgent.match(/ipad|iphone/i);
          if (isIOS) {
            // Create a range and select the input
            const range = document.createRange();
            range.selectNodeContents(input);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            input.setSelectionRange(0, text.length);
          } else {
            // Focus and select on other devices
            input.focus();
            input.select();
          }

          // Execute copy command
          try {
            document.execCommand("copy");
            showCopySuccess();
          } catch (err) {
            console.error("Fallback copy failed:", err);
            alert("Copy failed. Please copy the code manually: " + text);
          }

          // Clean up
          document.body.removeChild(input);
        }

        // --- Helpers ----------------------------------------------------
        function resizeCanvas() {
          canvas.width = wrapper.clientWidth;
          canvas.height = wrapper.clientHeight;
          generateOverlay();
        }

        function generateOverlay() {
          // Fill with requested horizontal gradient
          const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
          gradient.addColorStop(0, "#B6C8D4");
          gradient.addColorStop(0.2452, "#B4C2CB");
          gradient.addColorStop(0.6442, "#99A3AB");
          gradient.addColorStop(1, "#AFBCC6");
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Set composite mode so drawn circles punch holes
          ctx.globalCompositeOperation = "destination-out";
        }

        function positionFromEvent(e) {
          const rect = canvas.getBoundingClientRect();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function start(e) {
          isDrawing = true;
          draw(e);
        }
        function end() {
          if (!isDrawing) return;
          isDrawing = false;
          checkProgress();
        }
        function draw(e) {
          if (!isDrawing) return;
          e.preventDefault();
          const { x, y } = positionFromEvent(e);
          ctx.beginPath();
          ctx.arc(x, y, 18, 0, Math.PI * 2);
          ctx.fill();
        }

        function checkProgress() {
          const pixels = ctx.getImageData(
            0,
            0,
            canvas.width,
            canvas.height
          ).data;
          let transparent = 0;
          for (let i = 3; i < pixels.length; i += 4) {
            if (pixels[i] === 0) transparent++;
          }
          const percent = (transparent / (pixels.length / 4)) * 100;
          if (percent > 50) reveal();
        }

        function reveal() {
          canvas.style.transition = "opacity 0.4s";
          canvas.style.opacity = 0;
          canvas.style.pointerEvents = "none";
          detachEvents();

          // Change modal background to revealed background
          if (CONFIG.revealedBackground) {
            modal.style.background = CONFIG.revealedBackground;
          }

          // Add shimmer effect to scratch area
          wrapper.classList.add("shimmer-active");

          // Add pulsating effect to just the reward content
          reward.classList.add("pulsate-animation");

          // Replace main title with reward title
          const mainTitleEl = document.getElementById("mainTitle");
          if (mainTitleEl) {
            mainTitleEl.innerHTML = selectedReward.title;
          }

          // Replace subtitle with reward subtext
          const subtitleEl = document.getElementById("subtitle");
          if (subtitleEl) {
            subtitleEl.textContent = selectedReward.subtext;
            subtitleEl.style.fontSize = CONFIG.subtitle.fontSize;
            subtitleEl.style.color = CONFIG.subtitle.color;
            subtitleEl.style.lineHeight = "1.45";
          }

          if (CONFIG.enableConfettiOnReveal) {
            fireConfetti();
          }

          // Start Black Friday timer
          if (CONFIG.blackFridayTimer.enabled) {
            startBlackFridayTimer();
          }

          if (CONFIG.claimButton.enabled) {
            // Transform the "Reveal" button into a "Claim" button
            footerButton.style.display = "block";
            footerButton.textContent = CONFIG.claimButton.text;
            footerButton.style.background = CONFIG.claimButton.background;
            footerButton.style.color = CONFIG.claimButton.color;

            // Remove the old click listener and attach the claim handler
            footerButton.removeEventListener("click", reveal);
            footerButton.addEventListener(
              "click",
              () => {
                cleanup();
                window.location.href = CLAIM_URL;
              },
              { once: true }
            );
          } else {
            footerButton.style.opacity = 0;
          }
        }

        // --- Confetti ---------------------------------------------------
        function fireConfetti() {
          const colors = [
            "#FFC700",
            "#FF0000",
            "#2E3192",
            "#41F4BC",
            "#943DFF",
            "#FF61E6",
          ];
          const particleCount = 120;
          const gravity = 0.3;

          // Create overlay canvas
          const confettiCanvas = document.createElement("canvas");
          confettiCanvas.style.position = "fixed";
          confettiCanvas.style.top = "0";
          confettiCanvas.style.left = "0";
          confettiCanvas.style.width = "100%";
          confettiCanvas.style.height = "100%";
          confettiCanvas.style.pointerEvents = "none";
          confettiCanvas.style.zIndex = "9999";
          document.body.appendChild(confettiCanvas);

          const ctx2 = confettiCanvas.getContext("2d");
          confettiCanvas.width = window.innerWidth;
          confettiCanvas.height = window.innerHeight;

          const particles = [];

          const randomRange = (min, max) => Math.random() * (max - min) + min;

          for (let i = 0; i < particleCount; i++) {
            particles.push({
              x: confettiCanvas.width / 2,
              y: confettiCanvas.height * 0.6,
              w: randomRange(6, 12),
              h: randomRange(8, 16),
              angle: randomRange(0, 360),
              tiltAngleSpeed: randomRange(0.05, 0.12),
              color: colors[Math.floor(Math.random() * colors.length)],
              velocityX: randomRange(-9, 9),
              velocityY: randomRange(-16, -8),
              opacity: 1,
              decay: randomRange(0.0075, 0.015),
            });
          }

          let animationFrameId;

          const update = () => {
            ctx2.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

            particles.forEach((p, idx) => {
              p.x += p.velocityX;
              p.y += p.velocityY;
              p.velocityY += gravity;
              p.opacity -= p.decay;
              p.angle += (p.tiltAngleSpeed * 180) / Math.PI;

              if (p.opacity <= 0 || p.y > confettiCanvas.height + 20) {
                particles.splice(idx, 1);
              }
            });

            draw();

            if (particles.length) {
              animationFrameId = requestAnimationFrame(update);
            } else {
              cancelAnimationFrame(animationFrameId);
              confettiCanvas.remove();
            }
          };

          const draw = () => {
            particles.forEach((p) => {
              ctx2.save();
              ctx2.globalAlpha = Math.max(p.opacity, 0);
              ctx2.fillStyle = p.color;
              ctx2.translate(p.x, p.y);
              ctx2.rotate((p.angle * Math.PI) / 180);
              ctx2.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
              ctx2.restore();
            });
          };

          update();
        }

        // --- Events -----------------------------------------------------
        function attachEvents() {
          canvas.addEventListener("mousedown", start);
          canvas.addEventListener("mousemove", draw);
          canvas.addEventListener("mouseup", end);
          canvas.addEventListener("mouseleave", end);

          canvas.addEventListener("touchstart", start, { passive: false });
          canvas.addEventListener("touchmove", draw, { passive: false });
          canvas.addEventListener("touchend", end);
        }

        function detachEvents() {
          canvas.removeEventListener("mousedown", start);
          canvas.removeEventListener("mousemove", draw);
          canvas.removeEventListener("mouseup", end);
          canvas.removeEventListener("mouseleave", end);

          canvas.removeEventListener("touchstart", start);
          canvas.removeEventListener("touchmove", draw);
          canvas.removeEventListener("touchend", end);
        }

        // Button + resize
        if (CONFIG.revealButton.enabled) {
          footerButton.addEventListener("click", reveal);
        }

        const ro = new ResizeObserver(resizeCanvas);
        ro.observe(wrapper);

        // Cleanup function to properly disconnect observers and remove event listeners
        function cleanup() {
          ro.disconnect();
          detachEvents();
          if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
          }
        }

        // Listen for page unload to cleanup
        window.addEventListener("beforeunload", cleanup);

        // Also cleanup when the modal is closed
        if (closeBtn) {
          closeBtn.addEventListener("click", () => {
            cleanup();
            window.location.href = "wzkr://thisleadstonowhere";
          });
        }

        // Kick-off
        resizeCanvas();
        attachEvents();
      })();
    </script>
  </body>
</html>
