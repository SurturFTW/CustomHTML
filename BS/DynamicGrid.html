<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compact Markets Popup</title>

    <style>
      body {
        margin: 0 !important;
        font-family: Georgia, serif !important;
        text-align: left !important; /* Force left alignment */
      }

      /* OVERLAY */
      .popup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      /* SMALLER POPUP */
      .popup-container {
        background: #fff;
        width: 92%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
        border-radius: 6px;
        position: relative;
        text-align: left !important; /* Override CleverTap center alignment */
      }

      /* HEADER */
      .popup-header {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
        border-bottom: 1.5px solid #b01116;
        padding-bottom: 5px;
      }

      /* CLOSE */
      .close-popup {
        position: absolute;
        right: 12px;
        top: 8px;
        font-size: 18px;
        cursor: pointer;
      }

      /* GRID */
      .popup-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      /* CARD */
      .popup-card {
        display: flex;
        gap: 8px;
        padding: 8px;
        border: 1px solid #eee;
        border-left: 3px solid transparent;
        border-radius: 4px;
        text-decoration: none;
        color: #000;
        transition:
          transform 0.25s ease,
          box-shadow 0.25s ease,
          border-left 0.25s ease;
        cursor: pointer;
        background: #fff;
        text-align: left !important;
      }

      .popup-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
        border-left: 3px solid #b01116;
      }

      /* SMALL IMAGE */
      .popup-card img {
        width: 65px;
        height: 55px;
        object-fit: cover;
        border-radius: 3px;
      }

      /* CONTENT */
      .popup-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      /* SMALL TITLE */
      .popup-content h3 {
        font-size: 12.5px;
        margin: 0 0 4px 0;
        line-height: 1.3;
        font-weight: 600;
        text-align: left !important;
      }

      /* META */
      .meta {
        font-size: 10.5px;
        color: #777;
        text-align: left !important;
      }

      .meta .premium {
        color: #b01116;
        font-weight: 600;
      }

      /* LOADING STATE */
      .loading {
        text-align: center;
        padding: 20px;
        color: #777;
      }

      .error {
        text-align: center;
        padding: 20px;
        color: #b01116;
      }

      /* MOBILE */
      @media (max-width: 600px) {
        .popup-container {
          max-width: 95%;
          padding: 12px;
        }

        .popup-grid {
          grid-template-columns: 1fr;
        }

        .popup-card img {
          width: 60px;
          height: 50px;
        }
      }
    </style>
  </head>

  <body>
    <div class="popup-overlay" id="marketsPopup">
      <div class="popup-container">
        <span class="close-popup" onclick="closePopup()">x</span>
        <div class="popup-header">Article you might like</div>

        <div class="popup-grid" id="articlesGrid">
          <div class="loading">Loading articles...</div>
        </div>
      </div>
    </div>

    <script>
      const API_ENDPOINT = "http://localhost:3000/api/articles";

      async function loadArticles() {
        const grid = document.getElementById("articlesGrid");

        try {
          const response = await fetch(API_ENDPOINT);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Clear loading message
          grid.innerHTML = "";

          // Expected data format:
          // {
          //   "articles": [
          //     {
          //       "url": "https://...",
          //       "image": "https://...",
          //       "title": "Article title",
          //       "readTime": "5 min read",
          //       "isPremium": true
          //     }
          //   ]
          // }

          const articles = data.articles || data; // Handle both wrapped and direct array

          if (!articles || articles.length === 0) {
            grid.innerHTML = '<div class="error">No articles available</div>';
            return;
          }

          // Render each article
          articles.forEach((article) => {
            const card = createArticleCard(article);
            grid.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading articles:", error);
          grid.innerHTML =
            '<div class="error">Failed to load articles. Please try again later.</div>';
        }
      }

      function createArticleCard(article) {
        const card = document.createElement("a");
        card.href = article.url;
        card.className = "popup-card";
        card.target = "_blank";

        const img = document.createElement("img");
        img.src = article.image;
        img.alt = article.title;
        // Add error handling for images
        img.onerror = function () {
          this.src =
            'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="65" height="55"%3E%3Crect fill="%23eee" width="65" height="55"/%3E%3C/svg%3E';
        };

        const content = document.createElement("div");
        content.className = "popup-content";

        const title = document.createElement("h3");
        title.textContent = article.title;

        const meta = document.createElement("div");
        meta.className = "meta";

        const readTime = document.createTextNode(article.readTime || "");
        meta.appendChild(readTime);

        if (article.isPremium) {
          const separator = document.createTextNode(" | ");
          const premium = document.createElement("span");
          premium.className = "premium";
          premium.textContent = "Premium";
          meta.appendChild(separator);
          meta.appendChild(premium);
        }

        content.appendChild(title);
        content.appendChild(meta);

        card.appendChild(img);
        card.appendChild(content);

        return card;
      }

      function closePopup() {
        try {
          // First try to close parent elements
          var overlay =
            window.parent.document.getElementById("intentOpacityDiv");
          var wrapper = window.parent.document.getElementById("intentPreview");
          if (overlay) overlay.remove();
          if (wrapper) wrapper.remove();
        } catch (error) {
          console.error("Error removing parent elements:", error);
        }
        // Also hide the local overlay as fallback
        document.getElementById("marketsPopup").style.display = "none";
      }

      window.addEventListener("DOMContentLoaded", loadArticles);
    </script>
  </body>
</html>
